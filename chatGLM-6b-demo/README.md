# ğŸš€ğŸ’» åœ¨Macä¸Šå°è¯•è¿è¡ŒChatGLM-6Bæ¨¡å‹ï¼šä¸€æ®µå……æ»¡æŒ‘æˆ˜ä¸æ¢ç´¢çš„æ—…ç¨‹ ğŸŒŸğŸ§©

## æ‘˜è¦
æœ¬æ–‡è¯¦è¿°äº†åœ¨Mac M2ä¸Šéƒ¨ç½²å’Œè¿è¡ŒChatGLM-6Bæ¨¡å‹çš„æ–¹æ³•ã€‚æ–‡ç« æ¶µç›–Macç¯å¢ƒé…ç½®ã€æ¨¡å‹éƒ¨ç½²ã€è¯•è·‘DEMOç­‰æ­¥éª¤ï¼ŒåŠç›¸å…³ä»£ç ã€‚æˆåŠŸè¿è¡Œåï¼Œå¯åœ¨æœ‰é™ç¡¬ä»¶èµ„æºçš„ç”µè„‘ä¸Šä½¿ç”¨è¿™ä¸ªä¸­è‹±åŒè¯­é—®ç­”å¯¹è¯è¯­è¨€æ¨¡å‹ã€‚è¯¦ç»†å®‰è£…å’Œå…¶ä»–ç¯å¢ƒæ“ä½œè¯·å‚è€ƒå®˜ç½‘ã€‚

## å†™åœ¨å‰é¢

æœ€è¿‘å‘ç°æœ‰äº›æ¨¡å‹å±…ç„¶å¯ä»¥åœ¨ä¸ªäººç”µè„‘ä¸Šè·‘å•¦ï¼ğŸ˜²ğŸ‰ æˆ‘å°±è·ƒè·ƒæ¬²è¯•ï¼Œæ‰“ç®—åœ¨æˆ‘çš„Macç”µè„‘ä¸Šè¿è¡ŒChatGLM-6Bæ¨¡å‹ã€‚

ä¸ºä»€ä¹ˆé€‰Macå‘¢ï¼Ÿ  
å› ä¸ºæˆ‘æ‰‹å¤´å°±åªæœ‰ä¸€å°Macå˜›ï¼ğŸ˜…   
å¦‚æœæˆ‘èƒ½é¡ºåˆ©è¿è¡Œå¹¶è®­ç»ƒæ¨¡å‹ï¼Œä»¥åç©ï¼ˆå’³å’³ï¼Œæˆ‘æ˜¯è¯´å·¥ä½œï¼‰çš„ç©ºé—´å¯å°±å¤§äº†å“¦ï¼ğŸ‰ğŸš€ æ‰€ä»¥æˆ‘å°±è ¢è ¢åœ°å¼€å§‹ä¸‹æ‰‹......

é‚£ä¸ºå•¥é€‰ChatGLM-6Bå‘¢ï¼Ÿ   
å› ä¸ºå®ƒåœ¨æœ€è¿‘çš„ä¸€ä¸ªæ’åä¸­å¯æ˜¯ååˆ—å‰èŒ…å“¦ï¼ğŸ¥‡ğŸ† è€Œä¸”æœ€é‡è¦çš„æ˜¯ï¼Œå®ƒå¯¹ä¸­æ–‡æ”¯æŒè¶…çº§å‹å¥½ï¼ğŸˆµ   
å½“ç„¶å•¦ï¼Œå®é™…æ•ˆæœè¿˜å¾—è‡ªå·±è¯•è¯•çœ‹å’¯ã€‚

è¯´å®è¯ï¼Œæˆ‘å¯¹å¦‚ä½•å®‰è£…å’Œè®­ç»ƒæ¨¡å‹å¯æ˜¯ä¸€çªä¸é€šã€‚ğŸ¤·â€â™€ï¸ğŸ”§ äºæ˜¯æˆ‘åœ¨ç½‘ä¸Šæœäº†æœç›¸å…³æ•™ç¨‹ï¼Œç»“æœçœ‹å®Œåè§‰å¾—è‡ªå·±åƒæ˜¯åœ¨é›¾é‡Œæ¢èŠ±ï¼Œå¥½åƒå·²ç»æœ‰ä¸€å¤§å †é—®é¢˜ç­‰ç€æˆ‘å»æŒ‘æˆ˜äº†å‘¢ğŸ˜µã€‚
è¦åœ¨ç¡¬ä»¶èµ„æºæœ‰é™çš„ç”µè„‘ä¸Šè¿è¡Œæ¨¡å‹ç¡®å®æŒºæœ‰éš¾åº¦çš„ï¼Œä¸»è¦æ˜¯å› ä¸ºæ¨¡å‹å¯¹ç¡¬ä»¶éœ€æ±‚å¾ˆé«˜ï¼Œç‰¹åˆ«æ˜¯GPUå†…å­˜ã€‚
å†è€…ï¼Œä¸åŒç”µè„‘çš„ç¡¬ä»¶ç¯å¢ƒå·®å¼‚å¯ä¸å°ï¼Œæ¨¡å‹å¯¹ç¡¬ä»¶ä¹Ÿç‰¹åˆ«æ•æ„Ÿã€‚æ‰€ä»¥å¤§å®¶é‡åˆ°çš„é—®é¢˜å’Œè§£å†³æ–¹æ³•éƒ½åƒå¥‡ç™¾æ€ªçš„ğŸ˜…ã€‚
ä½†æœ€é‡è¦çš„æ˜¯ï¼šè¿™äº‹å„¿çœŸçš„å¯è¡Œï¼Macç”µè„‘ä¹Ÿèƒ½è·‘èµ·æ¥ï¼ğŸ’ªğŸŠ äºæ˜¯æˆ‘æ¯«ä¸çŠ¹è±«åœ°å†³å®šç»§ç»­......

æœ€åï¼Œæˆ‘è§‰å¾—æœ‰å¿…è¦è®°å½•ä¸‹æ¯ä¸€æ­¥ï¼ŒåŒ…æ‹¬é‡åˆ°çš„å‘å’Œæ€ä¹ˆçˆ¬å‘çš„ï¼Œè¿™æ ·å’Œæˆ‘ä¸€æ ·å¯¹æ–°æŠ€æœ¯æ„Ÿå…´è¶£çš„å°ä¼™ä¼´ä»¬ä¹Ÿèƒ½å‚è€ƒå•¦ï¼ğŸ“ğŸ¤—ğŸ’¡


## Mac ç¯å¢ƒ
Mac pro, Apple M2 MAX, memory 64G, Mac os 13.3.1

## éƒ¨ç½²

1. å®‰è£…pythonè™šæ‹Ÿç¯å¢ƒ   
    Pythoné—¨ä¸‹ä¸‡äº‹å¼€å¤´ï¼Œå…ˆè£…ä¸ªè™šæ‹Ÿç¯å¢ƒ[å¯é€‰]
    ï¼ˆç”¨Python 3.9ä¹Ÿå¯ä»¥ã€‚åœ¨æˆ‘çš„ç¯å¢ƒä¸‹ï¼ŒäºŒè€…å¹¶æ²¡æœ‰ä»€ä¹ˆæ˜æ˜¾å·®åˆ«ã€‚ï¼‰

    ```Shell
    conda create -n chatglm-6b-demo-310 python=3.10
    ```
      
    åˆ‡è¿›è™šæ‹Ÿç¯å¢ƒ
    ```Shell
    conda activate chatglm-6b-demo-310
    ```

2. ä¸‹è½½æ¨¡å‹  
    é¦–å…ˆï¼Œä» Hugging Face Hub ä¸‹è½½æ¨¡å‹éœ€è¦å…ˆå®‰è£…Git LFS ğŸ‘‰ğŸ‘‰ğŸ‘‰[è¿™é‡Œæœ‰è¯¦ç»†çš„å®‰è£…æ­¥éª¤](https://docs.github.com/zh/repositories/working-with-files/managing-large-files/installing-git-large-file-storage)ğŸ‘ˆğŸ‘ˆğŸ‘ˆ    
    ç„¶åç”¨gitæŠŠæ¨¡å‹æ‹‰åˆ°æœ¬åœ°ï¼Œè¿™ä¸ªæ­¥éª¤éå¸¸éå¸¸æ…¢ï¼Œæˆ‘è¯•äº†å‡ æ¬¡æ²¡æˆåŠŸã€‚å¦‚æœä¸æˆåŠŸï¼Œå¯ä»¥é‡‡ç”¨ä¸‹é¢ *æ¨¡å‹å®ç°* + æ‰‹åŠ¨ä¸‹*æ¨¡å‹å‚æ•°æ–‡ä»¶*çš„æ–¹å¼ã€‚
    ```Shell
    git clone https://huggingface.co/THUDM/chatglm-6b
    ```
    å¦‚æœç›´æ¥æ‹‰æ¨¡å‹å¤±è´¥ï¼Œå¯ä»¥ç”¨ä»¥ä¸‹å‘½ä»¤åªä¸‹è½½*æ¨¡å‹å®ç°*ã€‚
    ```Shell
    GIT_LFS_SKIP_SMUDGE=1 git clone https://huggingface.co/THUDM/chatglm-6b
    ```
    ç„¶åï¼Œæ‰‹åŠ¨ä¸‹è½½*æ¨¡å‹å‚æ•°æ–‡ä»¶*[ChatGLM-6B æ¨¡å‹æ–‡ä»¶](https://cloud.tsinghua.edu.cn/d/fb9f16d6dc8f482596c2/)
    å†æŠŠä¸‹è½½ä¸‹æ¥çš„æ¨¡å‹æ–‡ä»¶ï¼Œæ›¿æ¢æ‰ä¸Šä¸€æ­¥éª¤é‡Œçš„æ–‡ä»¶ã€‚(è®°ä¸‹æ¨¡å‹ç›®å½•ï¼Œç­‰ä¸‹ä»£ç é‡Œä¼šéœ€è¦ç”¨åˆ°ã€‚)
    è¿™æ ·æ¨¡å‹å°±ä¸‹å¥½äº†ï¼Œç›®å½•ç»“æ„å¦‚ä¸‹ï¼š      
    ![img.png](imgs/model-dirs.png)     

3. MACå‡†å¤‡    
æŒ‰ChatGLMå®˜ç½‘è¯´æ˜ï¼Œå¦‚æœ mac æ˜¯ç”¨Apple Silicon æˆ–è€… AMD GPU ï¼Œå¯ä»¥ä½¿ç”¨ MPS åç«¯æ¥åœ¨ GPU ä¸Šè¿è¡Œ ChatGLM-6Bã€‚
å¯ä»¥æŒ‰Apple çš„ å®˜æ–¹è¯´æ˜æ¥å®‰è£…PyTorch-Nightlyï¼ŒğŸ‘‰ğŸ‘‰ğŸ‘‰[ç‚¹è¿™é‡Œ](https://developer.apple.com/metal/pytorch/)ğŸ‘ˆğŸ‘ˆğŸ‘ˆ
âš ï¸æ³¨æ„ï¼šPyTorch-Nightlyçš„ç‰ˆæœ¬å·æ˜¯2.1.0.dev2023xxxxï¼Œè€Œä¸æ˜¯2.0.0ã€‚

    ```Shell
    pip3 install --pre torch torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/nightly/cpu
    ```
    å®‰è£…åï¼Œå†™ä¸ªpyæ–‡ä»¶éªŒè¯ä¸€ä¸‹ã€‚
    ```
    import torch
    if torch.backends.mps.is_available():
        mps_device = torch.device("mps")
        x = torch.ones(1, device=mps_device)
        print (x)
    else:
        print ("MPS device not found.")
    # æ­£å¸¸ä¼šè¾“å‡ºï¼štensor([1.], device='mps:0')
    ```

4. å®‰è£…æ¨¡å‹éœ€è¦çš„ä¾èµ–
    ä»¥ä¸‹æ˜¯å®˜ç½‘repoé‡Œrequirements.txtçš„å†…å®¹ã€‚
    ```
    # requirements.txt
    protobuf
    transformers==4.27.1
    cpm_kernels
    torch>=1.10
    gradio
    mdtex2html
    sentencepiece
    accelerate
    ```
    ä½ ä¹Ÿå¯ä»¥ä»æˆ‘çš„githubé‡Œä¸‹è½½è¿™ä¸ªæ–‡ä»¶ï¼Œç„¶åè¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥å®‰è£…
    ```Shell
    pip3 install -r requirements.txt
    ```


## è¯•è·‘DEMO
åˆ°æ­¤ï¼Œæ¨¡å‹å’Œç¯å¢ƒéƒ½å·²ç»å‡†å¤‡å¥½äº†,å¯ä»¥å¼€å§‹è¿è¡Œä»£ç ç½—ï½ï½ è·‘èµ·æ¥å§ï½ğŸƒğŸƒâ€ğŸƒâ€

### demo ä»£ç 

```
# demo1.py
from transformers import AutoTokenizer, AutoModel
from datetime import datetime
from dateutil import rrule

my_now = datetime.now()

# Mac åªèƒ½æœ¬åœ°åŠ è½½æ¨¡å‹ï¼ŒæŒ‡å®šæœ¬åœ°æ¨¡å‹ç›®å½•ã€‚(å°±æ˜¯åœ¨éƒ¨ç½²æ­¥éª¤2é‡Œæåˆ°çš„æ¨¡å‹ç›®å½•ï¼‰
chatglm_path = '*******æ¨¡å‹å­˜æ”¾çš„ç›®å½•*********'
tokenizer = AutoTokenizer.from_pretrained(chatglm_path, trust_remote_code=True, revision="v0.1.0")

# å¦‚æœè¿è¡Œæ—¶å‡ºé”™äº†ï¼Œå¯ä»¥æŠŠhalf æ”¹æˆ floatè¯•è¯•ã€‚ 
# æˆ‘åœ¨mac m2ä¸Šï¼Œç”¨halfå¹¶ä¸èƒ½æ¯æ¬¡éƒ½æˆåŠŸã€‚
# halfä¸‹å‡ºç»“æœæ˜æ˜¾è¦æ¯”floatå¿«ã€‚
model = AutoModel.from_pretrained(chatglm_path, trust_remote_code=True, revision="v0.1.0").half().to('mps')
# model = AutoModel.from_pretrained(chatglm_path, trust_remote_code=True, revision="v0.1.0").float().to('mps')

# half: 8 secondsï¼› float ï¼š 20 seconds+
model = model.eval()
response, history = model.chat(tokenizer, "ä½ å¥½?", history=[])
print(response)
print(f"[total spend]: {rrule.rrule(freq=rrule.SECONDLY, dtstart=my_now, until=datetime.now()).count()} seconds")

# 50 seconds+
my_now = datetime.now()
response, history = model.chat(tokenizer, "æ™šä¸Šç¡ä¸ç€åº”è¯¥æ€ä¹ˆåŠ", history=[])
print(response)
print(f"[total spend]: {rrule.rrule(freq=rrule.SECONDLY, dtstart=my_now, until=datetime.now()).count()} seconds")

my_now = datetime.now()
response, history = model.chat(tokenizer, "æ™šä¸Šèƒ½å–å’–å•¡ä¸ï¼Ÿ", history=[])
print(response)
print(f"[total spend]: {rrule.rrule(freq=rrule.SECONDLY, dtstart=my_now, until=datetime.now()).count()} seconds")

# 6 - 12 seconds+
my_now = datetime.now()
response, history = model.chat(tokenizer, "å°æ˜çš„çˆ¸çˆ¸æœ‰ä¸‰ä¸ªå„¿å­ï¼Œå¤§å„¿å­å«å¤§å®ï¼ŒäºŒå„¿å­å«äºŒå®ï¼Œä¸‰å„¿å­å«ä»€ä¹ˆï¼Ÿ", history=[])
print(response)
print(f"[total spend]: {rrule.rrule(freq=rrule.SECONDLY, dtstart=my_now, until=datetime.now()).count()} seconds")

```

### æ‰§è¡Œç»“æœï¼š
![img_1.png](imgs/demo1-output1.png)     
ğŸ‰ ğŸ‰ ğŸ‰ ğŸ‰ ğŸ‰ ğŸ‰    
ğŸ‰ ğŸ‰ ğŸ‰ ğŸ‰ ğŸ‰ ğŸ‰     
ğŸ‰ ğŸ‰ ğŸ‰ ğŸ‰ ğŸ‰ ğŸ‰      
è€¶ï¼ŒæˆåŠŸè¿è¡Œäº†ï½ï½ ç°åœ¨å°±æ‹¥æœ‰äº†ä¸€ä¸ªæœ¬åœ°æ¨¡å‹å•¦ï¼Œå—¯ï¼Œè®©æˆ‘æƒ³æƒ³ç”¨å®ƒæ¥ç©ç‚¹ä»€ä¹ˆå‘¢ï¼Ÿ



## å†™åœ¨åé¢
è¿™é‡Œåªåˆ†äº«äº†åœ¨Mac M2ä¸Šçš„ç›¸å…³æ­¥éª¤å“¦ğŸ˜‰ã€‚æƒ³è¦æ›´è¯¦ç»†çš„å®‰è£…å’Œå…¶ä»–ç¯å¢ƒä¸‹çš„æ“ä½œï¼Œå¤§å®¶å¯ä»¥å»æŸ¥é˜…å®˜ç½‘çš„è¯´æ˜ğŸ“šï¼Œé‚£é‡Œå¯æ˜¯éå¸¸è¯¦ç»†çš„å‘¢ï¼ğŸ‰ Have Funï¼ğŸ¥³ğŸŒˆ


## ChatGLM-6B ä»‹ç»
ChatGLM-6B æ˜¯ä¸€ä¸ªå¼€æºçš„ã€æ”¯æŒä¸­è‹±åŒè¯­é—®ç­”çš„å¯¹è¯è¯­è¨€æ¨¡å‹ï¼ŒåŸºäº [General Language Model (GLM)](https://github.com/THUDM/GLM) æ¶æ„ï¼Œå…·æœ‰ 62 äº¿å‚æ•°ã€‚ç»“åˆæ¨¡å‹é‡åŒ–æŠ€æœ¯ï¼Œç”¨æˆ·å¯ä»¥åœ¨æ¶ˆè´¹çº§çš„æ˜¾å¡ä¸Šè¿›è¡Œæœ¬åœ°éƒ¨ç½²ï¼ˆINT4 é‡åŒ–çº§åˆ«ä¸‹æœ€ä½åªéœ€ 6GB æ˜¾å­˜ï¼‰ã€‚ChatGLM-6B ä½¿ç”¨äº†å’Œ [ChatGLM](https://chatglm.cn) ç›¸åŒçš„æŠ€æœ¯ï¼Œé’ˆå¯¹ä¸­æ–‡é—®ç­”å’Œå¯¹è¯è¿›è¡Œäº†ä¼˜åŒ–ã€‚ç»è¿‡çº¦ 1T æ ‡è¯†ç¬¦çš„ä¸­è‹±åŒè¯­è®­ç»ƒï¼Œè¾…ä»¥ç›‘ç£å¾®è°ƒã€åé¦ˆè‡ªåŠ©ã€äººç±»åé¦ˆå¼ºåŒ–å­¦ä¹ ç­‰æŠ€æœ¯çš„åŠ æŒï¼Œ62 äº¿å‚æ•°çš„ ChatGLM-6B å·²ç»èƒ½ç”Ÿæˆç›¸å½“ç¬¦åˆäººç±»åå¥½çš„å›ç­”ã€‚

#### åè®®

ChatGLM-6B æ¨¡å‹çš„æƒé‡çš„ä½¿ç”¨åˆ™éœ€è¦éµå¾ª [Model License](MODEL_LICENSE)ã€‚
(ä¸å¯å•†ç”¨)


## å‚è€ƒï¼š
* [ChatGLM-6B GitHub](https://github.com/THUDM/ChatGLM-6B)   
* [ChatGLM-6B æ¨¡å‹æ–‡ä»¶](https://cloud.tsinghua.edu.cn/d/fb9f16d6dc8f482596c2/)   
* [ç¤ºä¾‹ä»£ç ](https://github.com/janewu77/jshare-llm-demo/tree/main/chatGLM-6b-demo)

